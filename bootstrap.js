/*
 This Source Code Form is subject to the terms of the Mozilla Public
 License, v. 2.0. If a copy of the MPL was not distributed with this
 file, You can obtain one at http://mozilla.org/MPL/2.0/.

 GitHub Web Components Polyfill Add-on
 Copyright (c) 2020 JustOff. All rights reserved.

 Web Components Polyfills 
 Copyright (c) 2014-2020 The Polymer Project Authors. All rights reserved.
 This code may only be used under the BSD style license found at
 http://polymer.github.io/LICENSE.txt The complete set of authors may be found
 at http://polymer.github.io/AUTHORS.txt The complete set of contributors may
 be found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by
 Google as part of the polymer project is also subject to an additional IP
 rights grant found at http://polymer.github.io/PATENTS.txt
*/

"use strict";

var Ci = Components.interfaces, Cu = Components.utils;

Cu.import("resource://gre/modules/Services.jsm");
Cu.import("resource://gre/modules/XPCOMUtils.jsm");

Cu.importGlobalProperties(["atob"]);

const polyfill = atob("KGZ1bmN0aW9uKCl7Cid1c2Ugc3RyaWN0Jzt2YXIgYWE9bmV3IFNldCgiYW5ub3RhdGlvbi14bWwgY29sb3ItcHJvZmlsZSBmb250LWZhY2UgZm9udC1mYWNlLXNyYyBmb250LWZhY2UtdXJpIGZvbnQtZmFjZS1mb3JtYXQgZm9udC1mYWNlLW5hbWUgbWlzc2luZy1nbHlwaCIuc3BsaXQoIiAiKSk7ZnVuY3Rpb24gZyhhKXt2YXIgYj1hYS5oYXMoYSk7YT0vXlthLXpdWy4wLTlfYS16XSotW1wtLjAtOV9hLXpdKiQvLnRlc3QoYSk7cmV0dXJuIWImJmF9ZnVuY3Rpb24gbChhKXt2YXIgYj1hLmlzQ29ubmVjdGVkO2lmKHZvaWQgMCE9PWIpcmV0dXJuIGI7Zm9yKDthJiYhKGEuX19DRV9pc0ltcG9ydERvY3VtZW50fHxhIGluc3RhbmNlb2YgRG9jdW1lbnQpOylhPWEucGFyZW50Tm9kZXx8KHdpbmRvdy5TaGFkb3dSb290JiZhIGluc3RhbmNlb2YgU2hhZG93Um9vdD9hLmhvc3Q6dm9pZCAwKTtyZXR1cm4hKCFhfHwhKGEuX19DRV9pc0ltcG9ydERvY3VtZW50fHxhIGluc3RhbmNlb2YgRG9jdW1lbnQpKX0KZnVuY3Rpb24gbihhLGIpe2Zvcig7YiYmYiE9PWEmJiFiLm5leHRTaWJsaW5nOyliPWIucGFyZW50Tm9kZTtyZXR1cm4gYiYmYiE9PWE/Yi5uZXh0U2libGluZzpudWxsfQpmdW5jdGlvbiBwKGEsYixkKXtkPXZvaWQgMD09PWQ/bmV3IFNldDpkO2Zvcih2YXIgYz1hO2M7KXtpZihjLm5vZGVUeXBlPT09Tm9kZS5FTEVNRU5UX05PREUpe3ZhciBlPWM7YihlKTt2YXIgZj1lLmxvY2FsTmFtZTtpZigibGluayI9PT1mJiYiaW1wb3J0Ij09PWUuZ2V0QXR0cmlidXRlKCJyZWwiKSl7Yz1lLmltcG9ydDtpZihjIGluc3RhbmNlb2YgTm9kZSYmIWQuaGFzKGMpKWZvcihkLmFkZChjKSxjPWMuZmlyc3RDaGlsZDtjO2M9Yy5uZXh0U2libGluZylwKGMsYixkKTtjPW4oYSxlKTtjb250aW51ZX1lbHNlIGlmKCJ0ZW1wbGF0ZSI9PT1mKXtjPW4oYSxlKTtjb250aW51ZX1pZihlPWUuX19DRV9zaGFkb3dSb290KWZvcihlPWUuZmlyc3RDaGlsZDtlO2U9ZS5uZXh0U2libGluZylwKGUsYixkKX1jPWMuZmlyc3RDaGlsZD9jLmZpcnN0Q2hpbGQ6bihhLGMpfX1mdW5jdGlvbiByKGEsYixkKXthW2JdPWR9O2Z1bmN0aW9uIHUoKXt0aGlzLmE9bmV3IE1hcDt0aGlzLmc9bmV3IE1hcDt0aGlzLmM9W107dGhpcy5mPVtdO3RoaXMuYj0hMX1mdW5jdGlvbiBiYShhLGIsZCl7YS5hLnNldChiLGQpO2EuZy5zZXQoZC5jb25zdHJ1Y3RvckZ1bmN0aW9uLGQpfWZ1bmN0aW9uIGNhKGEsYil7YS5iPSEwO2EuYy5wdXNoKGIpfWZ1bmN0aW9uIGRhKGEsYil7YS5iPSEwO2EuZi5wdXNoKGIpfWZ1bmN0aW9uIHYoYSxiKXthLmImJnAoYixmdW5jdGlvbihiKXtyZXR1cm4gdyhhLGIpfSl9ZnVuY3Rpb24gdyhhLGIpe2lmKGEuYiYmIWIuX19DRV9wYXRjaGVkKXtiLl9fQ0VfcGF0Y2hlZD0hMDtmb3IodmFyIGQ9MDtkPGEuYy5sZW5ndGg7ZCsrKWEuY1tkXShiKTtmb3IoZD0wO2Q8YS5mLmxlbmd0aDtkKyspYS5mW2RdKGIpfX0KZnVuY3Rpb24geChhLGIpe3ZhciBkPVtdO3AoYixmdW5jdGlvbihiKXtyZXR1cm4gZC5wdXNoKGIpfSk7Zm9yKGI9MDtiPGQubGVuZ3RoO2IrKyl7dmFyIGM9ZFtiXTsxPT09Yy5fX0NFX3N0YXRlP2EuY29ubmVjdGVkQ2FsbGJhY2soYyk6eShhLGMpfX1mdW5jdGlvbiB6KGEsYil7dmFyIGQ9W107cChiLGZ1bmN0aW9uKGIpe3JldHVybiBkLnB1c2goYil9KTtmb3IoYj0wO2I8ZC5sZW5ndGg7YisrKXt2YXIgYz1kW2JdOzE9PT1jLl9fQ0Vfc3RhdGUmJmEuZGlzY29ubmVjdGVkQ2FsbGJhY2soYyl9fQpmdW5jdGlvbiBBKGEsYixkKXtkPXZvaWQgMD09PWQ/e306ZDt2YXIgYz1kLnV8fG5ldyBTZXQsZT1kLml8fGZ1bmN0aW9uKGIpe3JldHVybiB5KGEsYil9LGY9W107cChiLGZ1bmN0aW9uKGIpe2lmKCJsaW5rIj09PWIubG9jYWxOYW1lJiYiaW1wb3J0Ij09PWIuZ2V0QXR0cmlidXRlKCJyZWwiKSl7dmFyIGQ9Yi5pbXBvcnQ7ZCBpbnN0YW5jZW9mIE5vZGUmJihkLl9fQ0VfaXNJbXBvcnREb2N1bWVudD0hMCxkLl9fQ0VfaGFzUmVnaXN0cnk9ITApO2QmJiJjb21wbGV0ZSI9PT1kLnJlYWR5U3RhdGU/ZC5fX0NFX2RvY3VtZW50TG9hZEhhbmRsZWQ9ITA6Yi5hZGRFdmVudExpc3RlbmVyKCJsb2FkIixmdW5jdGlvbigpe3ZhciBkPWIuaW1wb3J0O2lmKCFkLl9fQ0VfZG9jdW1lbnRMb2FkSGFuZGxlZCl7ZC5fX0NFX2RvY3VtZW50TG9hZEhhbmRsZWQ9ITA7dmFyIGY9bmV3IFNldChjKTtmLmRlbGV0ZShkKTtBKGEsZCx7dTpmLGk6ZX0pfX0pfWVsc2UgZi5wdXNoKGIpfSxjKTtpZihhLmIpZm9yKGI9CjA7YjxmLmxlbmd0aDtiKyspdyhhLGZbYl0pO2ZvcihiPTA7YjxmLmxlbmd0aDtiKyspZShmW2JdKX0KZnVuY3Rpb24geShhLGIpe2lmKHZvaWQgMD09PWIuX19DRV9zdGF0ZSl7dmFyIGQ9Yi5vd25lckRvY3VtZW50O2lmKGQuZGVmYXVsdFZpZXd8fGQuX19DRV9pc0ltcG9ydERvY3VtZW50JiZkLl9fQ0VfaGFzUmVnaXN0cnkpaWYoZD1hLmEuZ2V0KGIubG9jYWxOYW1lKSl7ZC5jb25zdHJ1Y3Rpb25TdGFjay5wdXNoKGIpO3ZhciBjPWQuY29uc3RydWN0b3JGdW5jdGlvbjt0cnl7dHJ5e2lmKG5ldyBjIT09Yil0aHJvdyBFcnJvcigiVGhlIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGRpZCBub3QgcHJvZHVjZSB0aGUgZWxlbWVudCBiZWluZyB1cGdyYWRlZC4iKTt9ZmluYWxseXtkLmNvbnN0cnVjdGlvblN0YWNrLnBvcCgpfX1jYXRjaCh0KXt0aHJvdyBiLl9fQ0Vfc3RhdGU9Mix0O31iLl9fQ0Vfc3RhdGU9MTtiLl9fQ0VfZGVmaW5pdGlvbj1kO2lmKGQuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKWZvcihkPWQub2JzZXJ2ZWRBdHRyaWJ1dGVzLGM9MDtjPGQubGVuZ3RoO2MrKyl7dmFyIGU9CmRbY10sZj1iLmdldEF0dHJpYnV0ZShlKTtudWxsIT09ZiYmYS5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2soYixlLG51bGwsZixudWxsKX1sKGIpJiZhLmNvbm5lY3RlZENhbGxiYWNrKGIpfX19dS5wcm90b3R5cGUuY29ubmVjdGVkQ2FsbGJhY2s9ZnVuY3Rpb24oYSl7dmFyIGI9YS5fX0NFX2RlZmluaXRpb247Yi5jb25uZWN0ZWRDYWxsYmFjayYmYi5jb25uZWN0ZWRDYWxsYmFjay5jYWxsKGEpfTt1LnByb3RvdHlwZS5kaXNjb25uZWN0ZWRDYWxsYmFjaz1mdW5jdGlvbihhKXt2YXIgYj1hLl9fQ0VfZGVmaW5pdGlvbjtiLmRpc2Nvbm5lY3RlZENhbGxiYWNrJiZiLmRpc2Nvbm5lY3RlZENhbGxiYWNrLmNhbGwoYSl9Owp1LnByb3RvdHlwZS5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2s9ZnVuY3Rpb24oYSxiLGQsYyxlKXt2YXIgZj1hLl9fQ0VfZGVmaW5pdGlvbjtmLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayYmLTE8Zi5vYnNlcnZlZEF0dHJpYnV0ZXMuaW5kZXhPZihiKSYmZi5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2suY2FsbChhLGIsZCxjLGUpfTtmdW5jdGlvbiBCKGEpe3ZhciBiPWRvY3VtZW50O3RoaXMuYz1hO3RoaXMuYT1iO3RoaXMuYj12b2lkIDA7QSh0aGlzLmMsdGhpcy5hKTsibG9hZGluZyI9PT10aGlzLmEucmVhZHlTdGF0ZSYmKHRoaXMuYj1uZXcgTXV0YXRpb25PYnNlcnZlcih0aGlzLmYuYmluZCh0aGlzKSksdGhpcy5iLm9ic2VydmUodGhpcy5hLHtjaGlsZExpc3Q6ITAsc3VidHJlZTohMH0pKX1mdW5jdGlvbiBDKGEpe2EuYiYmYS5iLmRpc2Nvbm5lY3QoKX1CLnByb3RvdHlwZS5mPWZ1bmN0aW9uKGEpe3ZhciBiPXRoaXMuYS5yZWFkeVN0YXRlOyJpbnRlcmFjdGl2ZSIhPT1iJiYiY29tcGxldGUiIT09Ynx8Qyh0aGlzKTtmb3IoYj0wO2I8YS5sZW5ndGg7YisrKWZvcih2YXIgZD1hW2JdLmFkZGVkTm9kZXMsYz0wO2M8ZC5sZW5ndGg7YysrKUEodGhpcy5jLGRbY10pfTtmdW5jdGlvbiBlYSgpe3ZhciBhPXRoaXM7dGhpcy5iPXRoaXMuYT12b2lkIDA7dGhpcy5jPW5ldyBQcm9taXNlKGZ1bmN0aW9uKGIpe2EuYj1iO2EuYSYmYihhLmEpfSl9ZnVuY3Rpb24gRChhKXtpZihhLmEpdGhyb3cgRXJyb3IoIkFscmVhZHkgcmVzb2x2ZWQuIik7YS5hPXZvaWQgMDthLmImJmEuYih2b2lkIDApfTtmdW5jdGlvbiBFKGEpe3RoaXMuYz0hMTt0aGlzLmE9YTt0aGlzLmo9bmV3IE1hcDt0aGlzLmY9ZnVuY3Rpb24oYil7cmV0dXJuIGIoKX07dGhpcy5iPSExO3RoaXMuZz1bXTt0aGlzLm89bmV3IEIoYSl9CkUucHJvdG90eXBlLmw9ZnVuY3Rpb24oYSxiKXt2YXIgZD10aGlzO2lmKCEoYiBpbnN0YW5jZW9mIEZ1bmN0aW9uKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDdXN0b20gZWxlbWVudCBjb25zdHJ1Y3RvcnMgbXVzdCBiZSBmdW5jdGlvbnMuIik7aWYoIWcoYSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJUaGUgZWxlbWVudCBuYW1lICciK2ErIicgaXMgbm90IHZhbGlkLiIpO2lmKHRoaXMuYS5hLmdldChhKSl0aHJvdyBFcnJvcigiQSBjdXN0b20gZWxlbWVudCB3aXRoIG5hbWUgJyIrYSsiJyBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQuIik7aWYodGhpcy5jKXRocm93IEVycm9yKCJBIGN1c3RvbSBlbGVtZW50IGlzIGFscmVhZHkgYmVpbmcgZGVmaW5lZC4iKTt0aGlzLmM9ITA7dHJ5e3ZhciBjPWZ1bmN0aW9uKGIpe3ZhciBhPWVbYl07aWYodm9pZCAwIT09YSYmIShhIGluc3RhbmNlb2YgRnVuY3Rpb24pKXRocm93IEVycm9yKCJUaGUgJyIrYisiJyBjYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24uIik7CnJldHVybiBhfSxlPWIucHJvdG90eXBlO2lmKCEoZSBpbnN0YW5jZW9mIE9iamVjdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlIGlzIG5vdCBhbiBvYmplY3QuIik7dmFyIGY9YygiY29ubmVjdGVkQ2FsbGJhY2siKTt2YXIgdD1jKCJkaXNjb25uZWN0ZWRDYWxsYmFjayIpO3ZhciBrPWMoImFkb3B0ZWRDYWxsYmFjayIpO3ZhciBoPWMoImF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayIpO3ZhciBtPWIub2JzZXJ2ZWRBdHRyaWJ1dGVzfHxbXX1jYXRjaChxKXtyZXR1cm59ZmluYWxseXt0aGlzLmM9ITF9Yj17bG9jYWxOYW1lOmEsY29uc3RydWN0b3JGdW5jdGlvbjpiLGNvbm5lY3RlZENhbGxiYWNrOmYsZGlzY29ubmVjdGVkQ2FsbGJhY2s6dCxhZG9wdGVkQ2FsbGJhY2s6ayxhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2s6aCxvYnNlcnZlZEF0dHJpYnV0ZXM6bSxjb25zdHJ1Y3Rpb25TdGFjazpbXX07YmEodGhpcy5hLAphLGIpO3RoaXMuZy5wdXNoKGIpO3RoaXMuYnx8KHRoaXMuYj0hMCx0aGlzLmYoZnVuY3Rpb24oKXtyZXR1cm4gZmEoZCl9KSl9O0UucHJvdG90eXBlLmk9ZnVuY3Rpb24oYSl7QSh0aGlzLmEsYSl9OwpmdW5jdGlvbiBmYShhKXtpZighMSE9PWEuYil7YS5iPSExO2Zvcih2YXIgYj1hLmcsZD1bXSxjPW5ldyBNYXAsZT0wO2U8Yi5sZW5ndGg7ZSsrKWMuc2V0KGJbZV0ubG9jYWxOYW1lLFtdKTtBKGEuYSxkb2N1bWVudCx7aTpmdW5jdGlvbihiKXtpZih2b2lkIDA9PT1iLl9fQ0Vfc3RhdGUpe3ZhciBlPWIubG9jYWxOYW1lLGY9Yy5nZXQoZSk7Zj9mLnB1c2goYik6YS5hLmEuZ2V0KGUpJiZkLnB1c2goYil9fX0pO2ZvcihlPTA7ZTxkLmxlbmd0aDtlKyspeShhLmEsZFtlXSk7Zm9yKDswPGIubGVuZ3RoOyl7dmFyIGY9Yi5zaGlmdCgpO2U9Zi5sb2NhbE5hbWU7Zj1jLmdldChmLmxvY2FsTmFtZSk7Zm9yKHZhciB0PTA7dDxmLmxlbmd0aDt0KyspeShhLmEsZlt0XSk7KGU9YS5qLmdldChlKSkmJkQoZSl9fX1FLnByb3RvdHlwZS5nZXQ9ZnVuY3Rpb24oYSl7aWYoYT10aGlzLmEuYS5nZXQoYSkpcmV0dXJuIGEuY29uc3RydWN0b3JGdW5jdGlvbn07CkUucHJvdG90eXBlLm09ZnVuY3Rpb24oYSl7aWYoIWcoYSkpcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBTeW50YXhFcnJvcigiJyIrYSsiJyBpcyBub3QgYSB2YWxpZCBjdXN0b20gZWxlbWVudCBuYW1lLiIpKTt2YXIgYj10aGlzLmouZ2V0KGEpO2lmKGIpcmV0dXJuIGIuYztiPW5ldyBlYTt0aGlzLmouc2V0KGEsYik7dGhpcy5hLmEuZ2V0KGEpJiYhdGhpcy5nLnNvbWUoZnVuY3Rpb24oYil7cmV0dXJuIGIubG9jYWxOYW1lPT09YX0pJiZEKGIpO3JldHVybiBiLmN9O0UucHJvdG90eXBlLnM9ZnVuY3Rpb24oYSl7Qyh0aGlzLm8pO3ZhciBiPXRoaXMuZjt0aGlzLmY9ZnVuY3Rpb24oZCl7cmV0dXJuIGEoZnVuY3Rpb24oKXtyZXR1cm4gYihkKX0pfX07d2luZG93LkN1c3RvbUVsZW1lbnRSZWdpc3RyeT1FO0UucHJvdG90eXBlLmRlZmluZT1FLnByb3RvdHlwZS5sO0UucHJvdG90eXBlLnVwZ3JhZGU9RS5wcm90b3R5cGUuaTtFLnByb3RvdHlwZS5nZXQ9RS5wcm90b3R5cGUuZ2V0OwpFLnByb3RvdHlwZS53aGVuRGVmaW5lZD1FLnByb3RvdHlwZS5tO0UucHJvdG90eXBlLnBvbHlmaWxsV3JhcEZsdXNoQ2FsbGJhY2s9RS5wcm90b3R5cGUuczt2YXIgRj13aW5kb3cuRG9jdW1lbnQucHJvdG90eXBlLmNyZWF0ZUVsZW1lbnQsRz13aW5kb3cuRG9jdW1lbnQucHJvdG90eXBlLmNyZWF0ZUVsZW1lbnROUyxoYT13aW5kb3cuRG9jdW1lbnQucHJvdG90eXBlLmltcG9ydE5vZGUsaWE9d2luZG93LkRvY3VtZW50LnByb3RvdHlwZS5wcmVwZW5kLGphPXdpbmRvdy5Eb2N1bWVudC5wcm90b3R5cGUuYXBwZW5kLGthPXdpbmRvdy5Eb2N1bWVudEZyYWdtZW50LnByb3RvdHlwZS5wcmVwZW5kLGxhPXdpbmRvdy5Eb2N1bWVudEZyYWdtZW50LnByb3RvdHlwZS5hcHBlbmQsSD13aW5kb3cuTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlLEk9d2luZG93Lk5vZGUucHJvdG90eXBlLmFwcGVuZENoaWxkLEo9d2luZG93Lk5vZGUucHJvdG90eXBlLmluc2VydEJlZm9yZSxLPXdpbmRvdy5Ob2RlLnByb3RvdHlwZS5yZW1vdmVDaGlsZCxMPXdpbmRvdy5Ob2RlLnByb3RvdHlwZS5yZXBsYWNlQ2hpbGQsTT1PYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbmRvdy5Ob2RlLnByb3RvdHlwZSwKInRleHRDb250ZW50IiksTj13aW5kb3cuRWxlbWVudC5wcm90b3R5cGUuYXR0YWNoU2hhZG93LE89T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW5kb3cuRWxlbWVudC5wcm90b3R5cGUsImlubmVySFRNTCIpLFA9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLmdldEF0dHJpYnV0ZSxRPXdpbmRvdy5FbGVtZW50LnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUsUj13aW5kb3cuRWxlbWVudC5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlLFM9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLmdldEF0dHJpYnV0ZU5TLFQ9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLnNldEF0dHJpYnV0ZU5TLFU9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZU5TLG1hPXdpbmRvdy5FbGVtZW50LnByb3RvdHlwZS5pbnNlcnRBZGphY2VudEVsZW1lbnQsbmE9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLmluc2VydEFkamFjZW50SFRNTCxvYT13aW5kb3cuRWxlbWVudC5wcm90b3R5cGUucHJlcGVuZCwKcGE9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLmFwcGVuZCxWPXdpbmRvdy5FbGVtZW50LnByb3RvdHlwZS5iZWZvcmUscWE9d2luZG93LkVsZW1lbnQucHJvdG90eXBlLmFmdGVyLHJhPXdpbmRvdy5FbGVtZW50LnByb3RvdHlwZS5yZXBsYWNlV2l0aCxzYT13aW5kb3cuRWxlbWVudC5wcm90b3R5cGUucmVtb3ZlLHRhPXdpbmRvdy5IVE1MRWxlbWVudCxXPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93LkhUTUxFbGVtZW50LnByb3RvdHlwZSwiaW5uZXJIVE1MIiksdWE9d2luZG93LkhUTUxFbGVtZW50LnByb3RvdHlwZS5pbnNlcnRBZGphY2VudEVsZW1lbnQsdmE9d2luZG93LkhUTUxFbGVtZW50LnByb3RvdHlwZS5pbnNlcnRBZGphY2VudEhUTUw7dmFyIHdhPW5ldyBmdW5jdGlvbigpe307ZnVuY3Rpb24geGEoKXt2YXIgYT1YO3dpbmRvdy5IVE1MRWxlbWVudD1mdW5jdGlvbigpe2Z1bmN0aW9uIGIoKXt2YXIgYj10aGlzLmNvbnN0cnVjdG9yLGM9YS5nLmdldChiKTtpZighYyl0aHJvdyBFcnJvcigiVGhlIGN1c3RvbSBlbGVtZW50IGJlaW5nIGNvbnN0cnVjdGVkIHdhcyBub3QgcmVnaXN0ZXJlZCB3aXRoIGBjdXN0b21FbGVtZW50c2AuIik7dmFyIGU9Yy5jb25zdHJ1Y3Rpb25TdGFjaztpZigwPT09ZS5sZW5ndGgpcmV0dXJuIGU9Ri5jYWxsKGRvY3VtZW50LGMubG9jYWxOYW1lKSxPYmplY3Quc2V0UHJvdG90eXBlT2YoZSxiLnByb3RvdHlwZSksZS5fX0NFX3N0YXRlPTEsZS5fX0NFX2RlZmluaXRpb249Yyx3KGEsZSksZTtjPWUubGVuZ3RoLTE7dmFyIGY9ZVtjXTtpZihmPT09d2EpdGhyb3cgRXJyb3IoIlRoZSBIVE1MRWxlbWVudCBjb25zdHJ1Y3RvciB3YXMgZWl0aGVyIGNhbGxlZCByZWVudHJhbnRseSBmb3IgdGhpcyBjb25zdHJ1Y3RvciBvciBjYWxsZWQgbXVsdGlwbGUgdGltZXMuIik7CmVbY109d2E7T2JqZWN0LnNldFByb3RvdHlwZU9mKGYsYi5wcm90b3R5cGUpO3coYSxmKTtyZXR1cm4gZn1iLnByb3RvdHlwZT10YS5wcm90b3R5cGU7T2JqZWN0LmRlZmluZVByb3BlcnR5KGIucHJvdG90eXBlLCJjb25zdHJ1Y3RvciIse3dyaXRhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMCxlbnVtZXJhYmxlOiExLHZhbHVlOmJ9KTtyZXR1cm4gYn0oKX07ZnVuY3Rpb24gWShhLGIsZCl7ZnVuY3Rpb24gYyhiKXtyZXR1cm4gZnVuY3Rpb24oZCl7Zm9yKHZhciBlPVtdLGM9MDtjPGFyZ3VtZW50cy5sZW5ndGg7KytjKWVbY109YXJndW1lbnRzW2NdO2M9W107Zm9yKHZhciBmPVtdLG09MDttPGUubGVuZ3RoO20rKyl7dmFyIHE9ZVttXTtxIGluc3RhbmNlb2YgRWxlbWVudCYmbChxKSYmZi5wdXNoKHEpO2lmKHEgaW5zdGFuY2VvZiBEb2N1bWVudEZyYWdtZW50KWZvcihxPXEuZmlyc3RDaGlsZDtxO3E9cS5uZXh0U2libGluZyljLnB1c2gocSk7ZWxzZSBjLnB1c2gocSl9Yi5hcHBseSh0aGlzLGUpO2ZvcihlPTA7ZTxmLmxlbmd0aDtlKyspeihhLGZbZV0pO2lmKGwodGhpcykpZm9yKGU9MDtlPGMubGVuZ3RoO2UrKylmPWNbZV0sZiBpbnN0YW5jZW9mIEVsZW1lbnQmJngoYSxmKX19dm9pZCAwIT09ZC5oJiYoYi5wcmVwZW5kPWMoZC5oKSk7dm9pZCAwIT09ZC5hcHBlbmQmJihiLmFwcGVuZD1jKGQuYXBwZW5kKSl9O2Z1bmN0aW9uIHlhKCl7dmFyIGE9WDtyKERvY3VtZW50LnByb3RvdHlwZSwiY3JlYXRlRWxlbWVudCIsZnVuY3Rpb24oYil7aWYodGhpcy5fX0NFX2hhc1JlZ2lzdHJ5KXt2YXIgZD1hLmEuZ2V0KGIpO2lmKGQpcmV0dXJuIG5ldyBkLmNvbnN0cnVjdG9yRnVuY3Rpb259Yj1GLmNhbGwodGhpcyxiKTt3KGEsYik7cmV0dXJuIGJ9KTtyKERvY3VtZW50LnByb3RvdHlwZSwiaW1wb3J0Tm9kZSIsZnVuY3Rpb24oYixkKXtiPWhhLmNhbGwodGhpcyxiLCEhZCk7dGhpcy5fX0NFX2hhc1JlZ2lzdHJ5P0EoYSxiKTp2KGEsYik7cmV0dXJuIGJ9KTtyKERvY3VtZW50LnByb3RvdHlwZSwiY3JlYXRlRWxlbWVudE5TIixmdW5jdGlvbihiLGQpe2lmKHRoaXMuX19DRV9oYXNSZWdpc3RyeSYmKG51bGw9PT1ifHwiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI9PT1iKSl7dmFyIGM9YS5hLmdldChkKTtpZihjKXJldHVybiBuZXcgYy5jb25zdHJ1Y3RvckZ1bmN0aW9ufWI9Ry5jYWxsKHRoaXMsYiwKZCk7dyhhLGIpO3JldHVybiBifSk7WShhLERvY3VtZW50LnByb3RvdHlwZSx7aDppYSxhcHBlbmQ6amF9KX07ZnVuY3Rpb24gemEoKXtmdW5jdGlvbiBhKGEsYyl7T2JqZWN0LmRlZmluZVByb3BlcnR5KGEsInRleHRDb250ZW50Iix7ZW51bWVyYWJsZTpjLmVudW1lcmFibGUsY29uZmlndXJhYmxlOiEwLGdldDpjLmdldCxzZXQ6ZnVuY3Rpb24oYSl7aWYodGhpcy5ub2RlVHlwZT09PU5vZGUuVEVYVF9OT0RFKWMuc2V0LmNhbGwodGhpcyxhKTtlbHNle3ZhciBkPXZvaWQgMDtpZih0aGlzLmZpcnN0Q2hpbGQpe3ZhciBlPXRoaXMuY2hpbGROb2RlcyxrPWUubGVuZ3RoO2lmKDA8ayYmbCh0aGlzKSl7ZD1BcnJheShrKTtmb3IodmFyIGg9MDtoPGs7aCsrKWRbaF09ZVtoXX19Yy5zZXQuY2FsbCh0aGlzLGEpO2lmKGQpZm9yKGE9MDthPGQubGVuZ3RoO2ErKyl6KGIsZFthXSl9fX0pfXZhciBiPVg7cihOb2RlLnByb3RvdHlwZSwiaW5zZXJ0QmVmb3JlIixmdW5jdGlvbihhLGMpe2lmKGEgaW5zdGFuY2VvZiBEb2N1bWVudEZyYWdtZW50KXt2YXIgZT1BcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYS5jaGlsZE5vZGVzKTsKYT1KLmNhbGwodGhpcyxhLGMpO2lmKGwodGhpcykpZm9yKGM9MDtjPGUubGVuZ3RoO2MrKyl4KGIsZVtjXSk7cmV0dXJuIGF9ZT1sKGEpO2M9Si5jYWxsKHRoaXMsYSxjKTtlJiZ6KGIsYSk7bCh0aGlzKSYmeChiLGEpO3JldHVybiBjfSk7cihOb2RlLnByb3RvdHlwZSwiYXBwZW5kQ2hpbGQiLGZ1bmN0aW9uKGEpe2lmKGEgaW5zdGFuY2VvZiBEb2N1bWVudEZyYWdtZW50KXt2YXIgYz1BcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYS5jaGlsZE5vZGVzKTthPUkuY2FsbCh0aGlzLGEpO2lmKGwodGhpcykpZm9yKHZhciBlPTA7ZTxjLmxlbmd0aDtlKyspeChiLGNbZV0pO3JldHVybiBhfWM9bChhKTtlPUkuY2FsbCh0aGlzLGEpO2MmJnooYixhKTtsKHRoaXMpJiZ4KGIsYSk7cmV0dXJuIGV9KTtyKE5vZGUucHJvdG90eXBlLCJjbG9uZU5vZGUiLGZ1bmN0aW9uKGEpe2E9SC5jYWxsKHRoaXMsISFhKTt0aGlzLm93bmVyRG9jdW1lbnQuX19DRV9oYXNSZWdpc3RyeT9BKGIsYSk6dihiLAphKTtyZXR1cm4gYX0pO3IoTm9kZS5wcm90b3R5cGUsInJlbW92ZUNoaWxkIixmdW5jdGlvbihhKXt2YXIgYz1sKGEpLGU9Sy5jYWxsKHRoaXMsYSk7YyYmeihiLGEpO3JldHVybiBlfSk7cihOb2RlLnByb3RvdHlwZSwicmVwbGFjZUNoaWxkIixmdW5jdGlvbihhLGMpe2lmKGEgaW5zdGFuY2VvZiBEb2N1bWVudEZyYWdtZW50KXt2YXIgZT1BcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYS5jaGlsZE5vZGVzKTthPUwuY2FsbCh0aGlzLGEsYyk7aWYobCh0aGlzKSlmb3IoeihiLGMpLGM9MDtjPGUubGVuZ3RoO2MrKyl4KGIsZVtjXSk7cmV0dXJuIGF9ZT1sKGEpO3ZhciBmPUwuY2FsbCh0aGlzLGEsYyksZD1sKHRoaXMpO2QmJnooYixjKTtlJiZ6KGIsYSk7ZCYmeChiLGEpO3JldHVybiBmfSk7TSYmTS5nZXQ/YShOb2RlLnByb3RvdHlwZSxNKTpjYShiLGZ1bmN0aW9uKGIpe2EoYix7ZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsZ2V0OmZ1bmN0aW9uKCl7Zm9yKHZhciBhPVtdLApiPTA7Yjx0aGlzLmNoaWxkTm9kZXMubGVuZ3RoO2IrKyl7dmFyIGY9dGhpcy5jaGlsZE5vZGVzW2JdO2Yubm9kZVR5cGUhPT1Ob2RlLkNPTU1FTlRfTk9ERSYmYS5wdXNoKGYudGV4dENvbnRlbnQpfXJldHVybiBhLmpvaW4oIiIpfSxzZXQ6ZnVuY3Rpb24oYSl7Zm9yKDt0aGlzLmZpcnN0Q2hpbGQ7KUsuY2FsbCh0aGlzLHRoaXMuZmlyc3RDaGlsZCk7bnVsbCE9YSYmIiIhPT1hJiZJLmNhbGwodGhpcyxkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShhKSl9fSl9KX07ZnVuY3Rpb24gQWEoYSl7ZnVuY3Rpb24gYihiKXtyZXR1cm4gZnVuY3Rpb24oZSl7Zm9yKHZhciBjPVtdLGQ9MDtkPGFyZ3VtZW50cy5sZW5ndGg7KytkKWNbZF09YXJndW1lbnRzW2RdO2Q9W107Zm9yKHZhciBrPVtdLGg9MDtoPGMubGVuZ3RoO2grKyl7dmFyIG09Y1toXTttIGluc3RhbmNlb2YgRWxlbWVudCYmbChtKSYmay5wdXNoKG0pO2lmKG0gaW5zdGFuY2VvZiBEb2N1bWVudEZyYWdtZW50KWZvcihtPW0uZmlyc3RDaGlsZDttO209bS5uZXh0U2libGluZylkLnB1c2gobSk7ZWxzZSBkLnB1c2gobSl9Yi5hcHBseSh0aGlzLGMpO2ZvcihjPTA7YzxrLmxlbmd0aDtjKyspeihhLGtbY10pO2lmKGwodGhpcykpZm9yKGM9MDtjPGQubGVuZ3RoO2MrKylrPWRbY10sayBpbnN0YW5jZW9mIEVsZW1lbnQmJngoYSxrKX19dmFyIGQ9RWxlbWVudC5wcm90b3R5cGU7dm9pZCAwIT09ViYmKGQuYmVmb3JlPWIoVikpO3ZvaWQgMCE9PVYmJihkLmFmdGVyPWIocWEpKTt2b2lkIDAhPT1yYSYmCnIoZCwicmVwbGFjZVdpdGgiLGZ1bmN0aW9uKGIpe2Zvcih2YXIgZT1bXSxjPTA7Yzxhcmd1bWVudHMubGVuZ3RoOysrYyllW2NdPWFyZ3VtZW50c1tjXTtjPVtdO2Zvcih2YXIgZD1bXSxrPTA7azxlLmxlbmd0aDtrKyspe3ZhciBoPWVba107aCBpbnN0YW5jZW9mIEVsZW1lbnQmJmwoaCkmJmQucHVzaChoKTtpZihoIGluc3RhbmNlb2YgRG9jdW1lbnRGcmFnbWVudClmb3IoaD1oLmZpcnN0Q2hpbGQ7aDtoPWgubmV4dFNpYmxpbmcpYy5wdXNoKGgpO2Vsc2UgYy5wdXNoKGgpfWs9bCh0aGlzKTtyYS5hcHBseSh0aGlzLGUpO2ZvcihlPTA7ZTxkLmxlbmd0aDtlKyspeihhLGRbZV0pO2lmKGspZm9yKHooYSx0aGlzKSxlPTA7ZTxjLmxlbmd0aDtlKyspZD1jW2VdLGQgaW5zdGFuY2VvZiBFbGVtZW50JiZ4KGEsZCl9KTt2b2lkIDAhPT1zYSYmcihkLCJyZW1vdmUiLGZ1bmN0aW9uKCl7dmFyIGI9bCh0aGlzKTtzYS5jYWxsKHRoaXMpO2ImJnooYSx0aGlzKX0pfTtmdW5jdGlvbiBCYSgpe2Z1bmN0aW9uIGEoYSxiKXtPYmplY3QuZGVmaW5lUHJvcGVydHkoYSwiaW5uZXJIVE1MIix7ZW51bWVyYWJsZTpiLmVudW1lcmFibGUsY29uZmlndXJhYmxlOiEwLGdldDpiLmdldCxzZXQ6ZnVuY3Rpb24oYSl7dmFyIGU9dGhpcyxkPXZvaWQgMDtsKHRoaXMpJiYoZD1bXSxwKHRoaXMsZnVuY3Rpb24oYSl7YSE9PWUmJmQucHVzaChhKX0pKTtiLnNldC5jYWxsKHRoaXMsYSk7aWYoZClmb3IodmFyIGY9MDtmPGQubGVuZ3RoO2YrKyl7dmFyIHQ9ZFtmXTsxPT09dC5fX0NFX3N0YXRlJiZjLmRpc2Nvbm5lY3RlZENhbGxiYWNrKHQpfXRoaXMub3duZXJEb2N1bWVudC5fX0NFX2hhc1JlZ2lzdHJ5P0EoYyx0aGlzKTp2KGMsdGhpcyk7cmV0dXJuIGF9fSl9ZnVuY3Rpb24gYihhLGIpe3IoYSwiaW5zZXJ0QWRqYWNlbnRFbGVtZW50IixmdW5jdGlvbihhLGUpe3ZhciBkPWwoZSk7YT1iLmNhbGwodGhpcyxhLGUpO2QmJnooYyxlKTtsKGEpJiZ4KGMsZSk7cmV0dXJuIGF9KX0KZnVuY3Rpb24gZChhLGIpe2Z1bmN0aW9uIGUoYSxiKXtmb3IodmFyIGU9W107YSE9PWI7YT1hLm5leHRTaWJsaW5nKWUucHVzaChhKTtmb3IoYj0wO2I8ZS5sZW5ndGg7YisrKUEoYyxlW2JdKX1yKGEsImluc2VydEFkamFjZW50SFRNTCIsZnVuY3Rpb24oYSxjKXthPWEudG9Mb3dlckNhc2UoKTtpZigiYmVmb3JlYmVnaW4iPT09YSl7dmFyIGQ9dGhpcy5wcmV2aW91c1NpYmxpbmc7Yi5jYWxsKHRoaXMsYSxjKTtlKGR8fHRoaXMucGFyZW50Tm9kZS5maXJzdENoaWxkLHRoaXMpfWVsc2UgaWYoImFmdGVyYmVnaW4iPT09YSlkPXRoaXMuZmlyc3RDaGlsZCxiLmNhbGwodGhpcyxhLGMpLGUodGhpcy5maXJzdENoaWxkLGQpO2Vsc2UgaWYoImJlZm9yZWVuZCI9PT1hKWQ9dGhpcy5sYXN0Q2hpbGQsYi5jYWxsKHRoaXMsYSxjKSxlKGR8fHRoaXMuZmlyc3RDaGlsZCxudWxsKTtlbHNlIGlmKCJhZnRlcmVuZCI9PT1hKWQ9dGhpcy5uZXh0U2libGluZyxiLmNhbGwodGhpcyxhLGMpLGUodGhpcy5uZXh0U2libGluZywKZCk7ZWxzZSB0aHJvdyBuZXcgU3ludGF4RXJyb3IoIlRoZSB2YWx1ZSBwcm92aWRlZCAoIitTdHJpbmcoYSkrIikgaXMgbm90IG9uZSBvZiAnYmVmb3JlYmVnaW4nLCAnYWZ0ZXJiZWdpbicsICdiZWZvcmVlbmQnLCBvciAnYWZ0ZXJlbmQnLiIpO30pfXZhciBjPVg7TiYmcihFbGVtZW50LnByb3RvdHlwZSwiYXR0YWNoU2hhZG93IixmdW5jdGlvbihhKXthPU4uY2FsbCh0aGlzLGEpO3ZhciBiPWM7aWYoYi5iJiYhYS5fX0NFX3BhdGNoZWQpe2EuX19DRV9wYXRjaGVkPSEwO2Zvcih2YXIgZT0wO2U8Yi5jLmxlbmd0aDtlKyspYi5jW2VdKGEpfXJldHVybiB0aGlzLl9fQ0Vfc2hhZG93Um9vdD1hfSk7TyYmTy5nZXQ/YShFbGVtZW50LnByb3RvdHlwZSxPKTpXJiZXLmdldD9hKEhUTUxFbGVtZW50LnByb3RvdHlwZSxXKTpkYShjLGZ1bmN0aW9uKGIpe2EoYix7ZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsZ2V0OmZ1bmN0aW9uKCl7cmV0dXJuIEguY2FsbCh0aGlzLCEwKS5pbm5lckhUTUx9LApzZXQ6ZnVuY3Rpb24oYSl7dmFyIGI9InRlbXBsYXRlIj09PXRoaXMubG9jYWxOYW1lLGM9Yj90aGlzLmNvbnRlbnQ6dGhpcyxlPUcuY2FsbChkb2N1bWVudCx0aGlzLm5hbWVzcGFjZVVSSSx0aGlzLmxvY2FsTmFtZSk7Zm9yKGUuaW5uZXJIVE1MPWE7MDxjLmNoaWxkTm9kZXMubGVuZ3RoOylLLmNhbGwoYyxjLmNoaWxkTm9kZXNbMF0pO2ZvcihhPWI/ZS5jb250ZW50OmU7MDxhLmNoaWxkTm9kZXMubGVuZ3RoOylJLmNhbGwoYyxhLmNoaWxkTm9kZXNbMF0pfX0pfSk7cihFbGVtZW50LnByb3RvdHlwZSwic2V0QXR0cmlidXRlIixmdW5jdGlvbihhLGIpe2lmKDEhPT10aGlzLl9fQ0Vfc3RhdGUpcmV0dXJuIFEuY2FsbCh0aGlzLGEsYik7dmFyIGU9UC5jYWxsKHRoaXMsYSk7US5jYWxsKHRoaXMsYSxiKTtiPVAuY2FsbCh0aGlzLGEpO2MuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKHRoaXMsYSxlLGIsbnVsbCl9KTtyKEVsZW1lbnQucHJvdG90eXBlLCJzZXRBdHRyaWJ1dGVOUyIsZnVuY3Rpb24oYSwKYixkKXtpZigxIT09dGhpcy5fX0NFX3N0YXRlKXJldHVybiBULmNhbGwodGhpcyxhLGIsZCk7dmFyIGU9Uy5jYWxsKHRoaXMsYSxiKTtULmNhbGwodGhpcyxhLGIsZCk7ZD1TLmNhbGwodGhpcyxhLGIpO2MuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKHRoaXMsYixlLGQsYSl9KTtyKEVsZW1lbnQucHJvdG90eXBlLCJyZW1vdmVBdHRyaWJ1dGUiLGZ1bmN0aW9uKGEpe2lmKDEhPT10aGlzLl9fQ0Vfc3RhdGUpcmV0dXJuIFIuY2FsbCh0aGlzLGEpO3ZhciBiPVAuY2FsbCh0aGlzLGEpO1IuY2FsbCh0aGlzLGEpO251bGwhPT1iJiZjLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayh0aGlzLGEsYixudWxsLG51bGwpfSk7cihFbGVtZW50LnByb3RvdHlwZSwicmVtb3ZlQXR0cmlidXRlTlMiLGZ1bmN0aW9uKGEsYil7aWYoMSE9PXRoaXMuX19DRV9zdGF0ZSlyZXR1cm4gVS5jYWxsKHRoaXMsYSxiKTt2YXIgZD1TLmNhbGwodGhpcyxhLGIpO1UuY2FsbCh0aGlzLGEsYik7dmFyIGU9Uy5jYWxsKHRoaXMsCmEsYik7ZCE9PWUmJmMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKHRoaXMsYixkLGUsYSl9KTt1YT9iKEhUTUxFbGVtZW50LnByb3RvdHlwZSx1YSk6bWE/YihFbGVtZW50LnByb3RvdHlwZSxtYSk6Y29uc29sZS53YXJuKCJDdXN0b20gRWxlbWVudHM6IGBFbGVtZW50I2luc2VydEFkamFjZW50RWxlbWVudGAgd2FzIG5vdCBwYXRjaGVkLiIpO3ZhP2QoSFRNTEVsZW1lbnQucHJvdG90eXBlLHZhKTpuYT9kKEVsZW1lbnQucHJvdG90eXBlLG5hKTpjb25zb2xlLndhcm4oIkN1c3RvbSBFbGVtZW50czogYEVsZW1lbnQjaW5zZXJ0QWRqYWNlbnRIVE1MYCB3YXMgbm90IHBhdGNoZWQuIik7WShjLEVsZW1lbnQucHJvdG90eXBlLHtoOm9hLGFwcGVuZDpwYX0pO0FhKGMpfTt2YXIgWj13aW5kb3cuY3VzdG9tRWxlbWVudHM7aWYoIVp8fFouZm9yY2VQb2x5ZmlsbHx8ImZ1bmN0aW9uIiE9dHlwZW9mIFouZGVmaW5lfHwiZnVuY3Rpb24iIT10eXBlb2YgWi5nZXQpe3ZhciBYPW5ldyB1O3hhKCk7eWEoKTtZKFgsRG9jdW1lbnRGcmFnbWVudC5wcm90b3R5cGUse2g6a2EsYXBwZW5kOmxhfSk7emEoKTtCYSgpO2RvY3VtZW50Ll9fQ0VfaGFzUmVnaXN0cnk9ITA7dmFyIGN1c3RvbUVsZW1lbnRzPW5ldyBFKFgpO09iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csImN1c3RvbUVsZW1lbnRzIix7Y29uZmlndXJhYmxlOiEwLGVudW1lcmFibGU6ITAsdmFsdWU6Y3VzdG9tRWxlbWVudHN9KX07Cn0pLmNhbGwodGhpcyk7");

const sha256 = "'sha256-S/zT4Ln6E7xGuKI45TJz8HEyEVXNDlfSIE2a0sgwuAM='";

var httpResponseObserver = {
  observe: function (subject, topic, data) {
    if ((topic == "http-on-examine-response" || topic == "http-on-examine-cached-response") &&
        subject instanceof Ci.nsIHttpChannel && subject.URI.host == "github.com" &&
        (subject.responseStatus == 200 || subject.responseStatus == 304)) {
      try {
        let ctype = subject.getResponseHeader("Content-Type").toLowerCase();
        if (ctype.indexOf("text/html") == -1 && ctype.indexOf("text/javascript") == -1) {
          return;
        }
      } catch (e) {}
      try {
        let csp = subject.getResponseHeader("Content-Security-Policy");
        csp = csp.replace("script-src ", "script-src " + sha256 + " ");
        csp = csp.replace("worker-src ", "worker-src github.githubassets.com ");
        subject.setResponseHeader("Content-Security-Policy", csp, false);
      } catch (e) {}
    }
  },
  QueryInterface: XPCOMUtils.generateQI([Ci.nsIObserver, Ci.nsISupportsWeakReference])
};

var deiObserver = {
  observe: function(subject, topic, data) {
    if (topic == "document-element-inserted" && subject instanceof Ci.nsIDOMDocument &&
        subject.defaultView && subject.defaultView == subject.defaultView.top &&
        subject.location.protocol == "https:" &&
        subject.location.hostname == "github.com" &&
        subject.contentType == "text/html") {
      let script = subject.createElement("script");
      script.textContent = polyfill;
      let heads = subject.documentElement.getElementsByTagName("head");
      if (heads.length && heads[0].firstElementChild) {
        heads[0].insertBefore(script, heads[0].firstElementChild);
      }
    }
  },
  QueryInterface: XPCOMUtils.generateQI([Ci.nsIObserver, Ci.nsISupportsWeakReference])
};

function startup(data, reason) {
  Services.obs.addObserver(httpResponseObserver, "http-on-examine-response", false);
  Services.obs.addObserver(httpResponseObserver, "http-on-examine-cached-response", false);
  Services.obs.addObserver(deiObserver, "document-element-inserted", false);
}

function shutdown(data, reason) {
  if (reason == APP_SHUTDOWN) {
    return;
  }
  Services.obs.removeObserver(deiObserver, "document-element-inserted", false);
  Services.obs.removeObserver(httpResponseObserver, "http-on-examine-cached-response", false);
  Services.obs.removeObserver(httpResponseObserver, "http-on-examine-response", false);
}

function install() {}

function uninstall() {}
